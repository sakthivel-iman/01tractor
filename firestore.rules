/**
 * This ruleset enforces a strict user-ownership security model for tractor telemetry data.
 *
 * Core Philosophy:
 * The security model ensures that all data is private and accessible only by the user who owns it.
 * There is no public or shared access to any data. This is designed to protect sensitive
 * location and operational data generated by each tractor.
 *
 * Data Structure:
 * All telemetry data is organized under a user-specific path. A top-level `users` collection holds
 * documents for each user, and all telemetry records for that user are stored in a nested
 * `tractorTelemetry` subcollection.
 * - /users/{userId}
 * - /users/{userId}/tractorTelemetry/{telemetryId}
 *
 * Key Security Decisions:
 * - User Isolation: A user can only interact with their own data tree, located at `/users/{their_auth_uid}`.
 *   They cannot read, write, or even know about the existence of other users' data.
 * - No User Enumeration: Listing documents in the top-level `/users` collection is explicitly disallowed
 *   to prevent scraping user IDs.
 * - Owner-Only Writes: All write operations (create, update, delete) are strictly limited to the
 *   authenticated owner of the data.
 *
 * Denormalization for Authorization:
 * This ruleset relies on path-based security. The user's ID (`userId`) in the document path is the sole
 * source of truth for ownership. This is highly performant as it avoids extra document reads (`get()` calls)
 * to determine permissions for subcollection documents.
 *
 * Structural Segregation:
 * The data is naturally segregated by user ID in the path, making it an effective and secure way to
 * isolate user data without needing separate public/private collections.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions to improve readability and reuse of logic.

    /**
     * Checks if a user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Validates that the requesting user's ID matches the user ID in the path.
     * This is the primary mechanism for enforcing data ownership.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Ensures an update or delete operation targets an existing document
     * and that the requester is the legitimate owner.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Rules for a user's own root document.
     * @path /users/{userId}
     * @allow A signed-in user (create)s their own user document at `/users/user_abc`.
     * @deny An anonymous user tries to (get) `/users/user_abc`.
     * @deny A signed-in user `user_xyz` tries to (get) `/users/user_abc`.
     * @principle Restricts access to a user's own data tree and prevents user enumeration.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) && resource != null;
      allow delete: if false;
    }

    /**
     * @description Secures tractor telemetry records, restricting all access to the data owner.
     * @path /users/{userId}/tractorTelemetry/{telemetryId}
     * @allow An authenticated user `user_abc` (create)s a new telemetry record in their own subcollection at `/users/user_abc/tractorTelemetry/new_record`.
     * @deny User `user_xyz` attempts to (list) records from `/users/user_abc/tractorTelemetry`.
     * @deny An anonymous user attempts to (delete) any telemetry record.
     * @principle Enforces strict data ownership for a user's private subcollection.
     */
    match /users/{userId}/tractorTelemetry/{telemetryId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }
  }
}